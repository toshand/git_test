# 動画文字起こしツール プログラムフローチャート

## メインプログラムフロー

```mermaid
flowchart TD
    A[プログラム開始] --> B[ライブラリインポート確認]
    B --> C[VideoToTextConverterクラス初期化]
    C --> D[UIセットアップ]
    D --> E[音声認識エンジン初期化]
    E --> F[GUI表示]
    F --> G[ユーザー操作待ち]
    
    G --> H{ファイル選択}
    H -->|動画ファイル選択| I[入力ファイルパス設定]
    H -->|出力ファイル選択| J[出力ファイルパス設定]
    H -->|変換開始ボタン| K[変換処理開始]
    
    I --> G
    J --> G
    
    K --> L[入力検証]
    L -->|エラー| M[エラーメッセージ表示]
    L -->|OK| N[別スレッドで変換処理実行]
    
    M --> G
    N --> O[変換完了]
    O --> G
```

## 変換処理フロー

```mermaid
flowchart TD
    A[変換処理開始] --> B[一時ディレクトリ作成]
    B --> C{ファイル形式判定}
    
    C -->|動画ファイル| D[ffmpegで音声抽出]
    C -->|音声ファイル| E[音声ファイルをそのまま使用]
    
    D --> F{音声抽出成功?}
    F -->|失敗| G[エラーログ出力]
    F -->|成功| H[音声認識エンジン選択]
    
    E --> H
    
    H --> I{エンジン選択}
    I -->|Google| J[Google Speech Recognition]
    I -->|Whisper| K[OpenAI Whisper]
    I -->|Sphinx| L[Sphinx]
    
    J --> M{文字起こし成功?}
    K --> M
    L --> M
    
    M -->|失敗| N[エラーメッセージ]
    M -->|成功| O{AI改善機能有効?}
    
    O -->|無効| P[テキストファイル保存]
    O -->|有効| Q[AI改善処理]
    
    Q --> R[テキストチャンク分割]
    R --> S[AI API呼び出し]
    S --> T[改善されたテキスト取得]
    T --> U[チャンク結合]
    U --> P
    
    P --> V[一時ファイル削除]
    V --> W[完了メッセージ表示]
    
    N --> V
    G --> V
```

## AI改善処理フロー

```mermaid
flowchart TD
    A[AI改善処理開始] --> B[テキスト長さ確認]
    B --> C{テキスト長 > チャンクサイズ?}
    
    C -->|No| D[単一チャンク処理]
    C -->|Yes| E[テキストチャンク分割]
    
    D --> F{AIプロバイダー選択}
    E --> G[複数チャンク処理]
    
    F -->|OpenAI| H[OpenAI API呼び出し]
    F -->|Anthropic| I[Anthropic API呼び出し]
    F -->|Custom| J[カスタムAPI呼び出し]
    
    G --> K[各チャンクを順次処理]
    K --> F
    
    H --> L{API呼び出し成功?}
    I --> L
    J --> L
    
    L -->|失敗| M[エラーハンドリング]
    L -->|成功| N[改善されたテキスト取得]
    
    M --> O{トークン制限エラー?}
    O -->|Yes| P[チャンクサイズ縮小]
    O -->|No| Q[元のテキスト返却]
    
    P --> R{最小サイズに達した?}
    R -->|No| F
    R -->|Yes| Q
    
    N --> S[改善結果返却]
    Q --> S
```

## 音声認識エンジン別フロー

### Google Speech Recognition
```mermaid
flowchart TD
    A[Google Speech Recognition開始] --> B[AudioFileで音声読み込み]
    B --> C[recognizer.recordで音声データ取得]
    C --> D[recognize_googleで文字起こし]
    D --> E{認識成功?}
    E -->|成功| F[テキスト返却]
    E -->|失敗| G[エラーハンドリング]
    G --> H[空文字列返却]
```

### OpenAI Whisper
```mermaid
flowchart TD
    A[Whisper処理開始] --> B[モデルサイズ取得]
    B --> C[whisper.load_modelでモデル読み込み]
    C --> D[言語コード変換]
    D --> E[model.transcribeで文字起こし]
    E --> F{処理成功?}
    F -->|成功| G[テキスト返却]
    F -->|失敗| H[エラーハンドリング]
    H --> I[空文字列返却]
```

### Sphinx
```mermaid
flowchart TD
    A[Sphinx処理開始] --> B[AudioFileで音声読み込み]
    B --> C[recognizer.recordで音声データ取得]
    C --> D[recognize_sphinxで文字起こし]
    D --> E{認識成功?}
    E -->|成功| F[テキスト返却]
    E -->|失敗| G[エラーハンドリング]
    G --> H[空文字列返却]
```

## UI操作フロー

```mermaid
flowchart TD
    A[UI初期化] --> B[メインキャンバス作成]
    B --> C[スクロール可能フレーム作成]
    C --> D[入力ファイル選択UI]
    D --> E[出力ファイル選択UI]
    E --> F[変換設定UI]
    F --> G[AI改善設定UI]
    G --> H[変換ボタン]
    H --> I[進捗バー]
    I --> J[ステータス表示]
    J --> K[ログ表示エリア]
    K --> L[マウスホイールスクロール設定]
    L --> M[スタイル設定]
    M --> N[UI表示完了]
```

## エラーハンドリングフロー

```mermaid
flowchart TD
    A[エラー発生] --> B{エラータイプ判定}
    
    B -->|ファイル関連| C[ファイル存在確認]
    B -->|ライブラリ関連| D[ライブラリ可用性確認]
    B -->|API関連| E[API接続確認]
    B -->|処理関連| F[処理ログ確認]
    
    C --> G[ファイルパス検証]
    D --> H[依存関係確認]
    E --> I[APIキー確認]
    F --> J[エラーログ出力]
    
    G --> K[ユーザーにエラーメッセージ表示]
    H --> K
    I --> K
    J --> K
    
    K --> L[処理継続可否判定]
    L -->|継続可能| M[処理再開]
    L -->|継続不可| N[処理終了]
```

## ファイル保存フロー

```mermaid
flowchart TD
    A[ファイル保存開始] --> B[出力ファイルパス確認]
    B --> C[ファイルヘッダー情報作成]
    C --> D[変換情報追加]
    D --> E{AI改善使用?}
    
    E -->|Yes| F[改善前後テキスト両方保存]
    E -->|No| G[元テキストのみ保存]
    
    F --> H[ファイル書き込み]
    G --> H
    
    H --> I{保存成功?}
    I -->|成功| J[完了メッセージ表示]
    I -->|失敗| K[エラーメッセージ表示]
    
    J --> L[処理完了]
    K --> L
```

このフローチャートは、動画文字起こしツールの主要な処理フローを視覚化したものです。各処理の流れと分岐点、エラーハンドリングが明確に示されています。


