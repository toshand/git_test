# メルカリ風C2Cサービス 単体テスト

## 概要

mercari_prototype.pyのC2レベル（分岐網羅率100%）の単体テストです。すべての分岐を網羅し、正常系・異常系・エッジケースを包括的にテストします。

## テスト構成

### テストファイル

1. **`test_mercari_prototype.py`** - メインの単体テスト
2. **`test_coverage_report.py`** - カバレッジ分析とレポート生成
3. **`run_tests.py`** - テスト実行スクリプト

### テストクラス

#### 1. TestMercariDatabase
**データベースクラスの単体テスト**

- **初期化テスト**
  - デフォルトパスでの初期化
  - カスタムパスでの初期化

- **接続テスト**
  - 接続成功
  - 接続失敗

- **切断テスト**
  - 接続ありでの切断
  - 接続なしでの切断

- **テーブル作成テスト**
  - 作成成功
  - 作成失敗

- **パスワードハッシュ化テスト**
  - 同じパスワードから同じハッシュ生成
  - 異なるパスワードから異なるハッシュ生成
  - ハッシュ長の確認

- **ユーザー作成テスト**
  - 作成成功
  - オプションフィールド付き作成
  - 重複ユーザー名
  - 重複メールアドレス
  - データベースエラー

- **ユーザー認証テスト**
  - 認証成功
  - 間違ったパスワード
  - 存在しないユーザー
  - 非アクティブユーザー
  - データベースエラー

- **商品作成テスト**
  - 作成成功
  - オプションフィールド付き作成
  - データベースエラー

- **商品検索テスト**
  - フィルターなし検索
  - クエリ付き検索
  - カテゴリフィルター
  - 価格範囲フィルター
  - 複合フィルター
  - データベースエラー

- **商品詳細取得テスト**
  - 取得成功
  - 存在しない商品
  - データベースエラー

- **取引作成テスト**
  - 作成成功
  - 支払い方法指定
  - データベースエラー

- **取引一覧取得テスト**
  - 購入者として取得
  - 出品者として取得
  - すべて取得
  - データベースエラー

#### 2. TestMercariApp
**アプリケーションクラスの単体テスト**

- **初期化テスト**
  - 正常な初期化

- **データベース初期化テスト**
  - 初期化成功
  - 接続失敗
  - テーブル作成失敗

- **サンプルデータ作成テスト**
  - 作成成功
  - 作成失敗

- **新規登録画面表示テスト**
  - 表示成功
  - 表示失敗

- **ログインテスト**
  - 空フィールド
  - 認証失敗
  - 認証成功

- **ログアウトテスト**
  - 正常なログアウト

- **商品作成テスト**
  - 空フィールド
  - 無効な価格
  - 作成成功
  - 作成失敗

#### 3. TestRegisterDialog
**新規登録ダイアログの単体テスト**

- **初期化テスト**
  - 正常な初期化

- **登録テスト**
  - 空フィールド
  - 登録失敗
  - 登録成功

#### 4. TestProductDetailDialog
**商品詳細ダイアログの単体テスト**

- **初期化テスト**
  - 正常な初期化

- **商品購入テスト**
  - 購入成功
  - 購入失敗
  - 購入キャンセル

## テスト実行方法

### 1. 基本的な実行方法

```bash
# テストディレクトリに移動
cd tests

# 単体テストを実行
python test_mercari_prototype.py

# カバレッジ分析付きで実行
python test_coverage_report.py

# 統合テスト実行スクリプト
python run_tests.py
```

### 2. 詳細な実行方法

```bash
# 特定のテストクラスのみ実行
python -m unittest test_mercari_prototype.TestMercariDatabase

# 特定のテストメソッドのみ実行
python -m unittest test_mercari_prototype.TestMercariDatabase.test_connect_success

# 詳細出力で実行
python -m unittest test_mercari_prototype -v
```

### 3. カバレッジ確認

```bash
# カバレッジレポートを生成
python test_coverage_report.py

# 統合テスト実行（カバレッジ分析付き）
python run_tests.py
```

## テスト結果の解釈

### 成功条件

1. **すべてのテストが成功** - 失敗やエラーがない
2. **C2レベル（分岐網羅率100%）** - すべての分岐がテストされている

### 出力例

```
================================================================================
メルカリ風C2Cサービス テストカバレッジレポート
================================================================================

クラス: MercariDatabase
----------------------------------------
総分岐数: 40
カバー済み分岐数: 40
分岐網羅率: 100.0%

クラス: MercariApp
----------------------------------------
総分岐数: 12
カバー済み分岐数: 12
分岐網羅率: 100.0%

クラス: RegisterDialog
----------------------------------------
総分岐数: 3
カバー済み分岐数: 3
分岐網羅率: 100.0%

クラス: ProductDetailDialog
----------------------------------------
総分岐数: 3
カバー済み分岐数: 3
分岐網羅率: 100.0%

================================================================================
全体サマリー
================================================================================
総分岐数: 58
カバー済み分岐数: 58
分岐網羅率: 100.0%

🎉 C2レベル（分岐網羅率100%）を達成しました！
================================================================================
```

## テスト設計の特徴

### 1. 分岐網羅率100%

- **if文の分岐**: True/False両方をテスト
- **try-except文**: 正常系と異常系をテスト
- **条件分岐**: すべての条件パターンをテスト

### 2. 包括的なテストケース

- **正常系**: 期待される動作のテスト
- **異常系**: エラー処理のテスト
- **エッジケース**: 境界値のテスト

### 3. モックの活用

- **データベース**: 一時ファイルを使用
- **UI**: Tkinterコンポーネントをモック
- **外部依存**: 必要な部分のみモック

### 4. 独立性の確保

- **テスト間の独立性**: 各テストが独立して実行可能
- **データの独立性**: テストデータが他のテストに影響しない
- **環境の独立性**: 外部環境に依存しない

## トラブルシューティング

### よくある問題

1. **インポートエラー**
   ```bash
   # パスの確認
   python -c "import sys; print(sys.path)"
   
   # モジュールの確認
   python -c "import mercari_prototype; print('OK')"
   ```

2. **データベースエラー**
   ```bash
   # 権限の確認
   ls -la tests/
   
   # 一時ファイルの確認
   ls -la /tmp/
   ```

3. **Tkinterエラー**
   ```bash
   # ディスプレイの確認（Linux）
   echo $DISPLAY
   
   # 仮想ディスプレイの設定
   export DISPLAY=:99
   ```

### デバッグ方法

1. **詳細出力での実行**
   ```bash
   python -m unittest test_mercari_prototype -v
   ```

2. **特定のテストのみ実行**
   ```bash
   python -m unittest test_mercari_prototype.TestMercariDatabase.test_connect_success -v
   ```

3. **デバッグモードでの実行**
   ```bash
   python -m pdb test_mercari_prototype.py
   ```

## 今後の拡張

### 1. パフォーマンステスト
- 大量データでのテスト
- メモリ使用量の測定
- 実行時間の測定

### 2. 統合テスト
- 複数コンポーネント間の連携テスト
- エンドツーエンドテスト

### 3. セキュリティテスト
- SQLインジェクション対策
- 認証・認可のテスト
- 入力値検証のテスト

## まとめ

このテストスイートは、mercari_prototype.pyのC2レベル（分岐網羅率100%）を達成するために設計されています。すべての分岐を網羅し、正常系・異常系・エッジケースを包括的にテストすることで、高品質なコードの実現を目指しています。
