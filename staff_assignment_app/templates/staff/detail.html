{% extends "base.html" %}

{% block title %}{{ staff.name }} - 要員詳細{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ staff.name }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('staff_list') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> 要員一覧に戻る
            </a>
            <a href="{{ url_for('staff_edit', staff_id=staff.id) }}" class="btn btn-sm btn-primary">
                <i class="fas fa-edit"></i> 編集
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- 基本情報 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user"></i> 基本情報
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="30%">社員ID:</th>
                                <td>{{ staff.employee_id }}</td>
                            </tr>
                            <tr>
                                <th>氏名:</th>
                                <td>{{ staff.name }}</td>
                            </tr>
                            <tr>
                                <th>会社:</th>
                                <td>
                                    <span class="badge bg-{{ 'primary' if staff.company_type.value == 'KOBELCO' else 'secondary' }}">
                                        {{ 'コベルコシステム' if staff.company_type.value == 'KOBELCO' else 'パートナー企業' }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="30%">部署:</th>
                                <td>{{ staff.department or '-' }}</td>
                            </tr>
                            <tr>
                                <th>メール:</th>
                                <td>{{ staff.email or '-' }}</td>
                            </tr>
                            <tr>
                                <th>電話:</th>
                                <td>{{ staff.phone or '-' }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 稼働状況 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i> 稼働状況
                </h5>
            </div>
            <div class="card-body">
                <div id="workload-container">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">読み込み中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 現在のアサイン -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tasks"></i> 現在のアサイン
                </h5>
            </div>
            <div class="card-body">
                <div id="assignments-container">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">読み込み中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- スキル -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs"></i> スキル
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="openSkillModal()">
                    <i class="fas fa-plus"></i> 追加
                </button>
            </div>
            <div class="card-body">
                <div id="skills-container">
                    {% if staff.skills %}
                        {% for skill in staff.skills %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-info">{{ skill.skill_type.value }}</span>
                            <span class="badge bg-secondary">{{ skill.proficiency_level.value }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">スキルが登録されていません。</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- プロフェッション -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-briefcase"></i> プロフェッション
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="openProfessionModal()">
                    <i class="fas fa-plus"></i> 追加
                </button>
            </div>
            <div class="card-body">
                <div id="professions-container">
                    {% if staff.professions %}
                        {% for profession in staff.professions %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-warning">{{ profession.profession_type.value }}</span>
                            <span class="badge bg-secondary">{{ profession.experience_years }}年</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">プロフェッションが登録されていません。</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 専門領域 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-industry"></i> 専門領域
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="openDomainModal()">
                    <i class="fas fa-plus"></i> 追加
                </button>
            </div>
            <div class="card-body">
                <div id="domains-container">
                    {% if staff.domains %}
                        {% for domain in staff.domains %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-success">{{ domain.domain_type.value }}</span>
                            <span class="badge bg-secondary">{{ domain.expertise_level.value }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">専門領域が登録されていません。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- スキル追加モーダル -->
<div class="modal fade" id="skillModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">スキル追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="skillForm">
                    <div class="mb-3">
                        <label for="skill_type" class="form-label">スキルタイプ</label>
                        <select class="form-select" id="skill_type" name="skill_type" required>
                            <option value="">選択してください</option>
                            <option value="OPEN">オープン系</option>
                            <option value="HOST">ホスト系</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="proficiency_level" class="form-label">習熟度レベル</label>
                        <select class="form-select" id="proficiency_level" name="proficiency_level" required>
                            <option value="">選択してください</option>
                            <option value="BEGINNER">初級</option>
                            <option value="INTERMEDIATE">中級</option>
                            <option value="ADVANCED">上級</option>
                            <option value="EXPERT">エキスパート</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="submitSkill()">追加</button>
            </div>
        </div>
    </div>
</div>

<!-- プロフェッション追加モーダル -->
<div class="modal fade" id="professionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">プロフェッション追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="professionForm">
                    <div class="mb-3">
                        <label for="profession_type" class="form-label">プロフェッションタイプ</label>
                        <select class="form-select" id="profession_type" name="profession_type" required>
                            <option value="">選択してください</option>
                            <option value="EXPERT">有識者</option>
                            <option value="PM">プロジェクトマネージャー</option>
                            <option value="DESIGNER">設計者</option>
                            <option value="DEVELOPER">開発者</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="experience_years" class="form-label">経験年数</label>
                        <input type="number" class="form-control" id="experience_years" name="experience_years" min="0" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="submitProfession()">追加</button>
            </div>
        </div>
    </div>
</div>

<!-- 専門領域追加モーダル -->
<div class="modal fade" id="domainModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">専門領域追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="domainForm">
                    <div class="mb-3">
                        <label for="domain_type" class="form-label">専門領域タイプ</label>
                        <select class="form-select" id="domain_type" name="domain_type" required>
                            <option value="">選択してください</option>
                            <option value="PRODUCTION">生産管理</option>
                            <option value="SALES">販売管理</option>
                            <option value="PROCUREMENT">調達管理</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="expertise_level" class="form-label">専門性レベル</label>
                        <select class="form-select" id="expertise_level" name="expertise_level" required>
                            <option value="">選択してください</option>
                            <option value="BEGINNER">初級</option>
                            <option value="INTERMEDIATE">中級</option>
                            <option value="ADVANCED">上級</option>
                            <option value="EXPERT">エキスパート</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="submitDomain()">追加</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 稼働状況を読み込み
loadWorkloadData();

function loadWorkloadData() {
    fetch(`/api/staff/{{ staff.id }}/workload`)
        .then(response => response.json())
        .then(data => {
            updateWorkloadDisplay(data);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('workload-container').innerHTML = 
                '<p class="text-danger">稼働状況の読み込みに失敗しました。</p>';
        });
}

function updateWorkloadDisplay(data) {
    const container = document.getElementById('workload-container');
    const utilization = (data.total_allocation * 100).toFixed(1);
    const availability = (data.available_capacity * 100).toFixed(1);
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>稼働率</h6>
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar bg-${utilization >= 80 ? 'danger' : utilization >= 50 ? 'warning' : 'success'}" 
                         role="progressbar" style="width: ${utilization}%">
                        ${utilization}%
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6>空き時間</h6>
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: ${availability}%">
                        ${availability}%
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <h6>現在のアサイン</h6>
            ${data.assignments.length > 0 ? 
                data.assignments.map(assignment => `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span>${assignment.project_name}</span>
                        <span class="badge bg-secondary">${(assignment.allocation_percentage * 100).toFixed(1)}%</span>
                    </div>
                `).join('') : 
                '<p class="text-muted">現在のアサインはありません。</p>'
            }
        </div>
    `;
}

// モーダル関数
function openSkillModal() {
    $('#skillModal').modal('show');
}

function openProfessionModal() {
    $('#professionModal').modal('show');
}

function openDomainModal() {
    $('#domainModal').modal('show');
}

function submitSkill() {
    const formData = {
        staff_id: {{ staff.id }},
        skill_type: document.getElementById('skill_type').value,
        proficiency_level: document.getElementById('proficiency_level').value
    };
    
    fetch('/api/staff/{{ staff.id }}/skills', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。');
    });
}

function submitProfession() {
    const formData = {
        staff_id: {{ staff.id }},
        profession_type: document.getElementById('profession_type').value,
        experience_years: parseInt(document.getElementById('experience_years').value)
    };
    
    fetch('/api/staff/{{ staff.id }}/professions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。');
    });
}

function submitDomain() {
    const formData = {
        staff_id: {{ staff.id }},
        domain_type: document.getElementById('domain_type').value,
        expertise_level: document.getElementById('expertise_level').value
    };
    
    fetch('/api/staff/{{ staff.id }}/domains', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。');
    });
}
</script>
{% endblock %}


